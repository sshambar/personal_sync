#!/bin/bash

TMPFILE=
cleanup() {
  [ -n "$TMPFILE" ] && rm -f "$TMPFILE"
}
trap cleanup 0

# check how we were called
[ -z "$1" ] && TMPFILE=$(mktemp -q -t emacs-tmp)

if [ -n "$TMPFILE" -a -w "$TMPFILE" ]; then

  # remove any color codes, [char]^H sequences...
  if [ -n "$(command -v perl)" ]; then
    perl -pe 's/\x1b\[[0-9;]*m//g;s/\x1b]4[^\\]*\\//g;s/.\x8//g' > "$TMPFILE"
  else
    # doesn't work if sed doesn't support "enhanced" basic expressions
    sed -e 's/\x1b\[[0-9;]*m//g' -e 's/\x1b]4[^\\]*\\//g' -e 's/.\x08//g' > "$TMPFILE"
  fi

  LINES=$(head -50 "$TMPFILE" | wc -l)
  if (( LINES < 40 )); then
    cat "$TMPFILE"
  else
    $EDITOR -n "$TMPFILE"
  fi

else
  # fallback to less
  less "$@"
fi
